"""
XSS_Vulnerability_Scanner - function to check site on XSS attack Vulnerability:

Usage: XSS_Vulnerability_Scanner <url>

    <url> - url where checking XSS attack Vulnerability
"""
import sys
import requests
from requests_html import HTMLSession
from find_forms import Forms
from urllib.parse import urljoin


class XSS_Vulnerability(object):

    def __init__(self, url):
        self.url = url

    def scan(self):
        session = HTMLSession()
        forms = Forms(session, self.url)
        forms = forms.search_forms()
        js_script = "<Script>alert('hi')</scripT>"
        is_vulnerable = False
        if not forms:
            return 0
        for form, detail in forms.items():
            content = self.submit_form(detail, self.url, js_script).content.decode()
            if js_script in content:
                print(f"\nXSS Detected on {self.url} in form: ")
                print('-------------------------')
                print("Form name: ", detail["name"])
                print("Action: ", detail["action"])
                print("Method: ", detail["method"])
                print("Inputs: ")
                for input in detail["inputs"]:
                    print("  " * 3, "-" * 4)
                    print("  " * 3, "Input name: ", input["name"])
                    print("  " * 3, "Input type: ", input["type"])
                    print("  " * 3, "Input value: ", input["value"] if input["value"] else "None")
                is_vulnerable = True
            return is_vulnerable

    def submit_form(self, form_details, url, value):
        target_url = urljoin(url, form_details["action"])
        inputs = form_details["inputs"]
        data = {}
        for input in inputs:
            if input["type"] == "text" or input["type"] == "search":
                input["value"] = value
            input_name = input.get("name")
            input_value = input.get("value")
            if input_name and input_value:
                data[input_name] = input_value

        if form_details["method"] == "post":
            return requests.post(target_url, data=data)
        else:
            return requests.get(target_url, params=data)


def main():
    if sys.argv[1] == '-h' or '--help':
        print(__doc__)
        sys.exit(0)
    injection = XSS_Vulnerability(sys.argv[1])
    is_vulnerable = injection.scan()
    if is_vulnerable:
        print(f'\nSite {sys.argv[1]} has an XSS vulnerability')
    else:
        print(f'\nSite {sys.argv[1]} has no XSS vulnerability')



if __name__ == '__main__':
    main()
